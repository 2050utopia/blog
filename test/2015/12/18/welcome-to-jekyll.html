<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="zhenglingxiao">

    <title>
        Test Blog &middot; Coture
    </title>

    <link rel="stylesheet" href="/blog/css/blog.css">

    <!-- Favicons -->
    <link rel="icon" href="/blog/favicon.ico">
    <!-- 苹果设备将网页添加至主屏幕时的ICON -->
    <link rel="apple-touch-icon-precomposed" href="/blog/img/apple-touch-icon-precomposed.png">
</head>

<body>

<div class='site-header'>
    <div class="container">
        <a href="/blog/"><img class="logo" src="/blog/images/logo.png"></a>
        <a class='title' href="/blog/">Coture</a>
        <span class='description right'>description</span>
    </div>
</div>

<div class="container">
    <div class="post-container">
    <div class="markdown-body">
        <h1 class="post-title">Test Blog</h1>
        <div><p>222在实际软件工作中，涉及研发、测试、产品经理等多个职位的配合。</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  ...
<span class="nt">&lt;/html&gt;</span>
</code></pre></div><div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nb">export </span><span class="nv">SXHKD_SHELL</span><span class="o">=</span>shell
</code></pre></div>
<p>时常会出现测试人员向研发要测试软件，产品经理想要体验软件向研发要最新软件，产品临时发样向研发人员要发样软件，如此之类的需求时常打断研发的工作。有时开发的过程中，测试人员发现了一个bug，进一步测试发现之前的代码中也存在这个bug，之前发出去的软件也存在这个bug，然后就开始了痛苦的代码回溯及编译APK验证测试。</p>

<p>因此需要一个自动软件编译平台来解决以上问题，这个平台每天凌晨自动编译一版本APK，所有需要APK的人员都可以登上FTP服务器获取，无需打断研发的工作。当回溯bug时只需要测试每天编译出来的APK就能很快定位到是哪次代码提交导致的问题。&lt;!-- more --&gt;本文使用Jenkins自动编译平台，vsftpd搭建FTP服务器，Git作为代码管理工具，使用Gradle编译APK，详细软件版本信息如下：  </p>

<ul>
<li>ubuntu：14.04<br></li>
<li>vsftpd：3.0.2<br></li>
<li>java：1.8.0_60<br></li>
<li>jenkins：1.609.3</li>
</ul>

<h3>一、安装配置Jenkins</h3>

<ol>
<li>从<a href="https://jenkins-ci.org">官网</a>下载Jenkins的deb安装包，虽然也能从命令行安装，但deb的安装方式更加简便。需要注意的是，有时首页的下载按钮会显示不出来，所以建议翻墙访问</li>
<li>安装完成后建议重启。然后打开浏览器：http://127.0.0.1:8080/ ，若能正常显示jenkins界面，则说明安装成功</li>
<li>点击右侧&quot;系统管理&quot;后选择&quot;管理插件&quot;，再选择&quot;可选插件&quot;选项卡，此时会列出所有可以安装的插件。在顶部的过滤对话框输入GIT plugin，选择GIT plugin进行安装。除了安装GIT plugin，可能还会自动安装其他关联的插件。建议先翻墙再进行此步操作，否则可能加载不出插件列表</li>
<li>安装jdk，假设安装到的路径为/usr/lib/java/jdk1.8.0<em>60，然后设置JAVA</em>HOME等环境变量，网上有很多教程，不再赘述</li>
<li>点击右侧&quot;系统管理&quot;后选择&quot;系统设置&quot;，点击“JDK安装”下的新增JDk。不要勾选自动安装，填写“别名”和“JAVA<em>HOME”，“别名”可以随便写，“JAVA</em>HOME”写/usr/lib/java/jdk1.8.0_60</li>
<li>点击底部保存，保存所有修改</li>
</ol>

<h2>二、为Jenkins添加ssh私钥</h2>

<p>jenkins在安装完成后，默认会创建一个jenkins账户，其根目录为/var/lib/jenkins。若在jenkins上使用git拉代码，则需要添加相应ssh私钥。</p>

<ol>
<li>先准备好可以在git上拉代码的私钥id_rsa</li>
<li>在/var/lib/jenkins目录下新建.ssh文件夹</li>
<li>将id_rsa复制到/var/lib/jenkins/.ssh</li>
<li>这一步非常重要，使用以下命令更改id<em>rsa的权限。修改完成后，id</em>rsa的权限为：
- r w - - - - - - - 1 jenkins jenkins 1675 Oct 13  2014 /var/lib/jenkins/.ssh/id<em>rsa
```
sudo chmod 600 id</em>rsa
sudo chgrp jenkins id<em>rsa
sudo chown jenkins id</em>rsa
```</li>
</ol>

<h2>三、下载配置Android SDK Tools</h2>

<ol>
<li>从Android官网下载SDK Tools，不需要下载整个Android Studio。下载完成后解压放置到/usr/local/android-sdk目录</li>
<li>启动SDK Tools，下载相应的android版本和编译工具，网上有很多教程，不再赘述</li>
<li>添加ANDROID<em>HOME环境变量，这个环境变量是jenkins通过gradle编译apk时需要用到的，考虑到ubuntu上的其他用户也要用到此环境变量，故添加为全局环境变量，在/etc/environment文件末尾加上export ANDROID</em>HOME=/usr/local/android-sdk。完成之后重新系统让环境变量生效</li>
</ol>

<h2>四、创建配置一个Jenkins编译项目</h2>

<ol>
<li>打开浏览器：http://127.0.0.1:8080/ ，选择“创建一个新任务”，再选择“构建一个自由风格的软件项目”并填写“Item名称”，这里给一个参考格式：项目名-nightly。点击OK后进入配置页面。</li>
<li>选择配置页面的“源码管理”下的Git，在Repository URL后填写代码的git地址，若jenkins无法通过此地址获取代码，那么稍等几秒界面上就会有红色的错误提示。Branches to build是用来指定要编译的分支名，默认是指向master的</li>
<li>点击“构建”下的“增加构建步骤”并选择Execute shell，在Command后面写gradle的编译命令及其他的shell脚本。此时先不写gradle的编译脚本，只写：echo hello!!!，因为jenkins执行自动编译是有超时时间的，在使用gradle编译apk时会先下载对应版本的gradle，在国内的下载速度是很慢的，经常会超过jenkins的编译超时时间，故需要单独初始化下载gradle</li>
<li>点击页面底部的保存按钮，完成配置。点击左侧的立即构建，开始第一次自动编译，点击“#1”进入详细页面，点击“Console Output”，查看实时的编译输出。当最后输出Finished: SUCCESS说明编译成功。此时jenkins已经将对应的代码拉到指定的目录了</li>
</ol>

<h2>五、初始化下载gradle</h2>

<ol>
<li>jenkins的所有自动编译项目都在/var/lib/jenkins/jobs目录下，假设此时的项目名称为test-nightly，那么源码所在的目录为/var/lib/jenkins/jobs/test-nightly/workspace</li>
<li><p>运行以下命令，初始化下载项目对应的gradle，之所以在这里执行，是因为既可以不受jenkins编译超市时间的限制，又可以看到实时的下载进度，建议翻墙后再执行以下操作，以免出现无法下载的情况。当执行完以下命令，出现BUILD SUCCESSFUL时说明操作成功</p>
<div class="highlight"><pre><code class="language-" data-lang="">sudo su jenkins # 切换到jenkins账户，这里会要求输入密码，输入的是你当前帐户的密码，而不是jenkins账户的密码
cd /var/lib/jenkins/jobs/test_night/workspace # 进入源码目录
./gradlew clean # 开始初始化下载gradle
</code></pre></div></li>
</ol>

<h2>六、完善Jenkins自动编译配置</h2>

<ol>
<li>打开浏览器：http://127.0.0.1:8080/ ，进入项目test-nightly的配置界面，勾选“构建触发器”下的Build periodically，此项是用来指定jenkins每日自动构建的时间点的。比如指定需要在每天凌晨5点到6点之间的随机事件点执行一次自动编译，那么填写：H 5 * * *，这里有五个参数，参数之间通过空格分割
第一个参数代表分钟，取值范围：0~59<br>
第二个参数代表的是小时，取值范围：0~23<br>
第三个参数代表的是天，取值范围：1~31<br>
第四个参数代表的是月，取值范围：1~12<br>
第五个参数代表的是星期，取值范围：0~7，0和7都是表示星期天<br>
*代表任意值，H代表该参数值域内的任意值</li>
<li>在Execute shell的Command处将之前的echo hello!!!改为以下脚本。保存后执行立即构建，出现BUILD SUCCESSFUL时说明操作成功。此时/var/lib/jenkins/build<em>release目录下已经有相应的子目录和apk了<br>
```
APP</em>NAME=test-nightly
DATE=<code>date &quot;+%y-%m-%d&quot;</code>
bash $WORKSPACE/gradlew clean build # 编译apk
DIR=~/build<em>release/${APP</em>NAME}/$DATE
if [ ! -d $DIR ]; then
mkdir -p $DIR
fi
mv $WORKSPACE/app/build/outputs/apk/app-release.apk $DIR/${APP<em>NAME}-${BUILD</em>NUMBER}.apk
```</li>
</ol>

<h2>七、搭建FTP服务器</h2>

<ol>
<li>搭建FTP服务器使用的是vsftpd，运行以下命令安装vsftpd<br>
<code>
sudo apt-get install vsftpd
</code></li>
<li>运行以下命令判断vsftpd是否安装成功并且已经启动<br>
<code>
sudo service vsftpd restart
</code></li>
<li>新建文件/etc/vsftpd.chroot<em>list和/etc/vsftpd.user</em>list，分别写上支持ftp登陆的账户名，比如我的ubuntu系统用户名是zhenglingxiao，就分别填写zhenglingxiao。这两个文件支持填写多个用户名，每行一个用户名，所以也可以建立专用的ftp用户</li>
<li><p>vsftpd的配置文件是/etc/vsftpd.conf，在文件末尾加上如下配置信息
    # 设置FTP登陆后转向的文件目录，这个目录是我们之前配置的jenkins编译后放置apk的目录
    local<em>root=/var/lib/jenkins/build</em>release/
    # 设置只有/etc/vsftpd.user<em>list中的用户才有登录FTP的权限
    userlist</em>enable=yes
    userlist<em>deny=NO
    userlist</em>file=/etc/vsftpd.user<em>list
    # 设置/etc/vsftpd.chroot</em>list中的用户在登陆FTP后只能查看本目录下的子目录和文件
    chroot<em>list</em>enable=YES
    chroot<em>list</em>file=/etc/vsftpd.chroot_list</p></li>
<li><p>在浏览器输入：ftp://服务器IP地址，会跳出登录窗口，登录后就能看到jenkins编译出来的apk了</p></li>
</ol>
</div>
    </div>
</div>


    <div class="site-footer">
        <ul class="site-footer-links right">
            <li><a href="https://github.com/zlxricky/blog">GitHub</a></li>
            <li><a href="/blog/about">About</a></li>
            <li><a href="/blog/feed.xml">RSS</a></li>
        </ul>

        <img src="/blog/images/avatar_small.png"/>

        <ul class="site-footer-links">
            <li>© 2016 ZhengLingxiao</li>
            <li>Powered by Jekyll & Primer</li>
        </ul>
    </div>
</div>

<script src="/blog/js/anchor.min.js"></script>
<script>
    var selector = '.markdown-body h2, .markdown-body h3';
    anchors.options = {
        placement: 'left',
        class: 'anchor-link'
    };
    anchors.add(selector);
</script>
</body>
</html>
