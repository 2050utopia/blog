<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="zhenglingxiao">

    <title>
        Android 6.0下使用Gson出现Can't make field constructor accessible的解决方案 &middot; Coture
    </title>

    <link rel="stylesheet" href="/blog/css/blog.css">

    <!-- Favicons -->
    <link rel="icon" href="/blog/favicon.ico">
    <!-- 苹果设备将网页添加至主屏幕时的ICON -->
    <link rel="apple-touch-icon-precomposed" href="/blog/images/apple-touch-icon-precomposed.png">
</head>

<body>

<div class='site-header'>
    <div class="container">
        <a href="/blog/"><img class="logo" src="/blog/images/logo.png"></a>
        <a class='title' href="/blog/">Coture</a>
        <span class='description right'>遇风尘之会，必有凌霄之志</span>
    </div>
</div>

<div class="container">
    <div class="post-container">
    <div class="markdown-body">
        <h2 class="post-title">Android 6.0下使用Gson出现Can't make field constructor accessible的解决方案</h2>
        <div><p>在Android 6.0上使用Gson某些情况下会出现：Can&#39;t make field constructor accessible的错误，经典的场景是ActiveAndroid和Gson配合使用，当使用Gson解析继承自ActiveAndroid的Model类的class时就会报此错误。</p>

<!-- more -->

<p>假设我们创建以下代码，运行会出现此错误。</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Field</span> <span class="n">field</span><span class="o">;</span> <span class="c1">// 这行挂掉了</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="s">"{\"name\": \"zhenglingxiao\", \"age\": 25}"</span><span class="o">;</span>
    <span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Gson</span><span class="o">();</span>
    <span class="n">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"sxy"</span><span class="o">,</span> <span class="n">student</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">student</span><span class="o">.</span><span class="na">age</span><span class="o">);</span>
<span class="err">｝</span>
</code></pre></div>
<p>这里挂掉的原因是在Student类中有一个Field变量，Field在序列化/反序列化时出现了错误，定位到的代码是java.lang.reflect.Constructor。那么为什么当对Field进行序列化/反序列化时会报错呢？在这个过程中Constructor究竟背地里背着我们都干了什么？数百头母驴为何半夜惨叫？小卖部安全套为何屡遭黑手？女生宿舍内裤为何频频失窃？连环强奸母猪案，究竟是何人所为？老尼姑的门夜夜被敲，究竟是人是鬼？数百只小母狗意外身亡的背后又隐藏着什么？这一切的背后， 是人性的扭曲还是道德的沦丧？是性的爆发还是饥渴的无奈？让我们接着看代码。</p>

<p>其实在Gson内部进行解析json时必须是用到反射机制了，而Constructor的setAccessible方法是这样定义的：</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAccessible</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">flag</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">declaringClass</span> <span class="o">=</span> <span class="n">getDeclaringClass</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">declaringClass</span> <span class="o">==</span> <span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">SecurityException</span><span class="o">(</span><span class="s">"Can't make class constructor accessible"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">declaringClass</span> <span class="o">==</span> <span class="n">Field</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">SecurityException</span><span class="o">(</span><span class="s">"Can't make field constructor accessible"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">declaringClass</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">SecurityException</span><span class="o">(</span><span class="s">"Can't make method constructor accessible"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="n">flag</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>看来原因已经很明显了，这里是不让你反射反射库的类。这里的Constructor是Android SDK内部集成的，不是原生JDK中的。当然其实很多类库也会使用反射机制，用到Field的情况就很难避免了。比如ActiveAndroid的Model类中有个TableInfo的变量，TableInfo类中又有一个Map<Field, String>变量，这样就导致出现了这个错误。那么如何避免呢？其实使用transient关键字即可，transient关键字的作用在于标示某个变量不进行序列化/反序列化。Student类修改为这样即可。</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">transient</span> <span class="n">Field</span> <span class="n">field</span><span class="o">;</span> <span class="c1">// 这行不会挂掉了</span>
<span class="o">}</span>
</code></pre></div>
<p>当然考虑到ActiveAndroid基本已经停止维护了，所以只能自己改代码了。当然有时这样改开源代码也是很蛋疼的，给后期维护也带来一定的工作量。还可以使用Gson的ExclusionStrategy这样处理。当处理到Field或者Method类的时候就不进行序列化和反序列化。</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

    <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="s">"{\"name\": \"Ricky\", \"age\": 25}"</span><span class="o">;</span>

    <span class="n">ExclusionStrategy</span> <span class="n">exclusionStrategy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExclusionStrategy</span><span class="o">()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">shouldSkipField</span><span class="o">(</span><span class="n">FieldAttributes</span> <span class="n">fieldAttributes</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">shouldSkipClass</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">clazz</span> <span class="o">==</span> <span class="n">Field</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="n">Method</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="n">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GsonBuilder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">addSerializationExclusionStrategy</span><span class="o">(</span><span class="n">exclusionStrategy</span><span class="o">)</span>
            <span class="o">.</span><span class="na">addDeserializationExclusionStrategy</span><span class="o">(</span><span class="n">exclusionStrategy</span><span class="o">)</span>
            <span class="o">.</span><span class="na">create</span><span class="o">();</span>

    <span class="c1">// Student is a simple class extends com.activeandroid.Model</span>
    <span class="n">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="n">gson</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">student</span><span class="o">.</span><span class="na">save</span><span class="o">();</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">students</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Select</span><span class="o">().</span><span class="na">from</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">students</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">students</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Student</span> <span class="n">stu</span> <span class="o">=</span> <span class="n">students</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"zlx"</span><span class="o">,</span> <span class="n">stu</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">"'s age: "</span> <span class="o">+</span> <span class="n">stu</span><span class="o">.</span><span class="na">age</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
    </div>
</div>


    <div class="site-footer">
        <ul class="site-footer-links right">
            <li><a href="https://github.com/zlxricky/blog">GitHub</a></li>
            <li><a href="/blog/about">About</a></li>
            <li><a href="/blog/feed.xml">RSS</a></li>
        </ul>

        <img src="/blog/images/logo.png"/>

        <ul class="site-footer-links">
            <li>© 2016 ZhengLingxiao</li>
            <li>Powered by Jekyll & Primer</li>
        </ul>
    </div>
</div>

<script src="/blog/js/anchor.min.js"></script>
<!--
<script>
    var selector = '.markdown-body h2, .markdown-body h3';
    anchors.options = {
        placement: 'left',
        class: 'anchor-link'
    };
    anchors.add(selector);
</script>
-->
</body>
</html>
