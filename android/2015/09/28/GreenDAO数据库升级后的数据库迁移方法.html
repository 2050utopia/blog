<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="zhenglingxiao">

    <title>
        GreenDAO数据库升级后的数据库迁移方法 &middot; Coture
    </title>

    <link rel="stylesheet" href="/blog/css/blog.css">

    <!-- Favicons -->
    <link rel="icon" href="/blog/favicon.ico">
    <!-- 苹果设备将网页添加至主屏幕时的ICON -->
    <link rel="apple-touch-icon-precomposed" href="/blog/images/apple-touch-icon-precomposed.png">
</head>

<body>

<div class='site-header'>
    <div class="container">
        <a href="/blog/"><img class="logo" src="/blog/images/logo.png"></a>
        <a class='title' href="/blog/">Coture</a>
        <span class='description right'>遇风尘之会，必有凌霄之志</span>
    </div>
</div>

<div class="container">
    <div class="post-container">
    <div class="markdown-body">
        <h2 class="post-title">GreenDAO数据库升级后的数据库迁移方法</h2>
        <div><p>在Android开发中进行数据库操作的时候，为了加快开发进度，通常会使用一些第三方类库，如GreenDAO、ActiveAndroid等。使用GreenDAO碰到数据库升级，即Schema的版本号变更，数据库结构或表结构变更的时候，都会涉及数据迁移的操作。否则默认情况下升级最新apk后，GreenDAO会直接删除之前的所有数据库表，然后新建数据库表，导致用户数据丢失。</p>

<!-- more -->

<h3>一、示例项目代码展示</h3>

<p>GreenDAO的使用详见官方文档，这里只展示主要代码。示例项目假设有一个music-db的数据库，数据库中有一个MUSIC的数据库表。MUSIC表三个版本的表结构如下：</p>

<p>Version 1:</p>

<table><thead>
<tr>
<th style="text-align: left">列名</th>
<th style="text-align: left">类型</th>
<th style="text-align: left">备注</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">ID</td>
<td style="text-align: left">TEXT</td>
<td style="text-align: left">主键</td>
</tr>
<tr>
<td style="text-align: left">NAME</td>
<td style="text-align: left">TEXT</td>
<td style="text-align: left"></td>
</tr>
</tbody></table>

<p>Version 2:</p>

<table><thead>
<tr>
<th style="text-align: left">列名</th>
<th style="text-align: left">类型</th>
<th style="text-align: left">备注</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">ID</td>
<td style="text-align: left">TEXT</td>
<td style="text-align: left">主键</td>
</tr>
<tr>
<td style="text-align: left">NAME</td>
<td style="text-align: left">TEXT</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: left">DURATION</td>
<td style="text-align: left">TEXT</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: left">AUTHOR</td>
<td style="text-align: left">TEXT</td>
<td style="text-align: left"></td>
</tr>
</tbody></table>

<p>Version 3:</p>

<table><thead>
<tr>
<th style="text-align: left">列名</th>
<th style="text-align: left">类型</th>
<th style="text-align: left">备注</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">ID</td>
<td style="text-align: left">TEXT</td>
<td style="text-align: left">主键</td>
</tr>
<tr>
<td style="text-align: left">NAME</td>
<td style="text-align: left">TEXT</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: left">DURATION</td>
<td style="text-align: left">TEXT</td>
<td style="text-align: left"></td>
</tr>
</tbody></table>

<p>以下是MainActivity的GreenDAO初始化数据库的代码</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">MusicDao</span> <span class="n">mMusicDao</span><span class="o">;</span>

   <span class="nd">@Override</span>
   <span class="kd">protected</span> <span class="kt">void</span> <span class="n">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
       <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
       <span class="n">initDataBase</span><span class="o">();</span>
       <span class="c1">// TODO your code</span>
   <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="n">initDataBase</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">dbName</span> <span class="o">=</span> <span class="s">"music-db"</span><span class="o">;</span>
        <span class="n">DaoMaster</span><span class="o">.</span><span class="na">DevOpenHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DaoMaster</span><span class="o">.</span><span class="na">DevOpenHelper</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">dbName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">SQLiteDatabase</span> <span class="n">db</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">getWritableDatabase</span><span class="o">();</span>
        <span class="n">DaoMaster</span> <span class="n">daoMaster</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DaoMaster</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
        <span class="n">DaoSession</span> <span class="n">daoSession</span> <span class="o">=</span> <span class="n">daoMaster</span><span class="o">.</span><span class="na">newSession</span><span class="o">();</span>
        <span class="n">mMusicDao</span> <span class="o">=</span> <span class="n">daoSession</span><span class="o">.</span><span class="na">getMusicDao</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="o">......</span>
<span class="o">}</span>        
</code></pre></div>
<p>以下是Version 1的DaoGenerator</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyApplicationDaoGenerator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="n">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Schema</span> <span class="n">schema</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Schema</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"com.zlxrx.myapplication.dao"</span><span class="o">);</span>
        <span class="n">addMusic</span><span class="o">(</span><span class="n">schema</span><span class="o">);</span>
        <span class="k">new</span> <span class="n">DaoGenerator</span><span class="o">().</span><span class="na">generateAll</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="s">"app/src/main/java"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="n">addMusic</span><span class="o">(</span><span class="n">Schema</span> <span class="n">schema</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Entity</span> <span class="n">music</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="na">addEntity</span><span class="o">(</span><span class="s">"Music"</span><span class="o">);</span>
        <span class="n">music</span><span class="o">.</span><span class="na">addStringProperty</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="na">primaryKey</span><span class="o">();</span>
        <span class="n">music</span><span class="o">.</span><span class="na">addStringProperty</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<h3>二、GreenDAO源码分析</h3>

<p>为什么当schema的版本号更新后会导致数据丢失呢？让我们接着看代码。</p>

<p>主要是在初始化数据库操作的这一句代码</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">DaoMaster</span><span class="o">.</span><span class="na">DevOpenHelper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DaoMaster</span><span class="o">.</span><span class="na">DevOpenHelper</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">dbName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</code></pre></div>
<p>查看DaoMaster.DevOpenHelper的源码，我们发现它其实继承自DaoMaster.OpenHelper，并Override了onUpgrade，此方法在schema的版本号更新时会调用，onUpgrade的主代码就两句：</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">dropAllTables</span><span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="n">onCreate</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>
</code></pre></div></div>
    </div>
</div>


    <div class="site-footer">
        <ul class="site-footer-links right">
            <li><a href="https://github.com/zlxricky/blog">GitHub</a></li>
            <li><a href="/blog/about">About</a></li>
            <li><a href="/blog/feed.xml">RSS</a></li>
        </ul>

        <img src="/blog/images/logo.png"/>

        <ul class="site-footer-links">
            <li>© 2016 ZhengLingxiao</li>
            <li>Powered by Jekyll & Primer</li>
        </ul>
    </div>
</div>

<script src="/blog/js/anchor.min.js"></script>
<!--
<script>
    var selector = '.markdown-body h2, .markdown-body h3';
    anchors.options = {
        placement: 'left',
        class: 'anchor-link'
    };
    anchors.add(selector);
</script>
-->
</body>
</html>
